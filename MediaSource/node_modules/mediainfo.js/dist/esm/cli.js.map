{"version":3,"file":"cli.js","names":["promises","fsPromises","hideBin","yargs","FORMAT_CHOICES","MediaInfoFactory","analyze","coverData","file","format","full","fileHandle","fileSize","mediainfo","TypeError","includes","readChunk","size","offset","undefined","Error","buffer","Uint8Array","read","open","stat","console","log","analyzeData","close","parseArgs","yargsInstance","process","argv","wrap","terminalWidth","option","alias","default","describe","choices","type","command","positional","help","fail","msg","err","error","message","exit","parseSync","catch"],"sourceRoot":"../../src","sources":["cli.ts"],"sourcesContent":["#!/usr/bin/env node\n\nimport { promises as fsPromises } from 'fs'\n\nimport { hideBin } from 'yargs/helpers'\nimport yargs from 'yargs/yargs'\n\nimport type { ReadChunkFunc } from './MediaInfo'\nimport type MediaInfo from './MediaInfo'\nimport { FORMAT_CHOICES } from './MediaInfo'\nimport MediaInfoFactory from './MediaInfoFactory'\n\nconst analyze = async ({ coverData, file, format, full }: ReturnType<typeof parseArgs>) => {\n  let fileHandle: fsPromises.FileHandle | undefined\n  let fileSize: number\n  let mediainfo: MediaInfo<typeof format> | undefined\n\n  if (!file) {\n    throw TypeError('No file received!')\n  }\n\n  if (coverData && !['JSON', 'XML'].includes(format)) {\n    throw TypeError('For cover data you need to choose JSON or XML as output format!')\n  }\n\n  const readChunk: ReadChunkFunc = async (size, offset) => {\n    if (fileHandle === undefined) throw new Error('File unavailable')\n    const buffer = new Uint8Array(size)\n    await fileHandle.read(buffer, 0, size, offset)\n    return buffer\n  }\n\n  try {\n    fileHandle = await fsPromises.open(file, 'r')\n    fileSize = (await fileHandle.stat()).size\n    mediainfo = await MediaInfoFactory({ format, coverData, full })\n    if (mediainfo === undefined) {\n      throw new Error('Failed to initialize MediaInfo')\n    }\n    console.log(await mediainfo.analyzeData(() => fileSize, readChunk))\n  } finally {\n    fileHandle && (await fileHandle.close())\n    mediainfo && mediainfo.close()\n  }\n}\n\nfunction parseArgs() {\n  const yargsInstance = yargs(hideBin(process.argv))\n  return yargsInstance\n    .wrap(yargsInstance.terminalWidth())\n    .option('format', {\n      alias: 'f',\n      default: 'text' as const,\n      describe: 'Choose format',\n      choices: FORMAT_CHOICES,\n    })\n    .option('cover-data', {\n      default: false,\n      describe: 'Output cover data as base64',\n      type: 'boolean',\n    })\n    .option('full', {\n      default: false,\n      describe: 'Full information display (all internal tags)',\n      type: 'boolean',\n    })\n    .command('$0 <file>', 'Show information about media file')\n    .positional('file', { describe: 'File to analyze', type: 'string' })\n    .help('h')\n    .alias('h', 'help')\n    .fail((msg: string, err: Error, argv) => {\n      if (msg) {\n        console.error(argv.help())\n        console.error(msg)\n      }\n      if (err) {\n        console.error(err.message)\n      }\n      process.exit(1)\n    })\n    .parseSync()\n}\n\nanalyze(parseArgs()).catch(console.error)\n"],"mappings":"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"}